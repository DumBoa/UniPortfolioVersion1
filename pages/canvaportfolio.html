<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="../assets/js/export.js"></script>
    <link rel="stylesheet" href="../assets/css/canvaportfolio.css">
    <script src="https://cdn.jsdelivr.net/npm/mo-js@1.7.0/build/mo.min.js"></script>
    <title>Project Portfolio Builder</title>
    <style>

    </style>
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header" role="banner">
            <div class="header-left">
                <!-- Added Navigation Bar -->
                <nav class="main-nav" role="navigation" aria-label="Main navigation">
                    <a href="Dashboard.html" class="nav-link" aria-label="Go to Home">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />
                            <polyline points="9,22 9,12 15,12 15,22" />
                        </svg>
                        Home
                    </a>
                </nav>
                <h1>Project Portfolio Builder</h1>
                <button class="btn" id="undoBtn" disabled aria-label="Hoàn tác">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 7v6h6" />
                        <path d="m21 17-3-3-3 3" />
                        <path d="M21 7v6" />
                        <path d="m3 17 3-3 3 3" />
                    </svg>
                    Undo
                </button>
                <button class="btn" id="redoBtn" disabled aria-label="Làm lại">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 7v6h-6" />
                        <path d="m3 17 3-3 3 3" />
                        <path d="M3 7v6" />
                        <path d="m21 17-3-3-3 3" />
                    </svg>
                    Redo
                </button>
            </div>
            <div class="header-right">
                <div class="responsive-controls">
                    <button class="responsive-btn active" data-breakpoint="desktop" aria-label="Xem desktop">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2" />
                            <line x1="8" y1="21" x2="16" y2="21" />
                            <line x1="12" y1="17" x2="12" y2="21" />
                        </svg>
                    </button>
                    <button class="responsive-btn" data-breakpoint="tablet" aria-label="Xem tablet">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="4" y="2" width="16" height="20" rx="2" ry="2" />
                            <line x1="12" y1="18" x2="12.01" y2="18" />
                        </svg>
                    </button>
                    <button class="responsive-btn" data-breakpoint="mobile" aria-label="Xem mobile">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <rect x="5" y="2" width="14" height="20" rx="2" ry="2" />
                            <line x1="12" y1="18" x2="12.01" y2="18" />
                        </svg>
                    </button>
                </div>
                <button class="btn" id="previewBtn" aria-label="Xem trước">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z" />
                        <circle cx="12" cy="12" r="3" />
                    </svg>
                    Preview
                </button>
                <button class="btn primary" id="publishBtn" aria-label="Xuất bản">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                        <polyline points="7,10 12,15 17,10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>
                    Publish
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Canvas Area -->
            <section class="canvas-area" role="main" aria-label="Khu vực thiết kế">
                <div class="canvas-toolbar">
                    <label>
                        <input type="checkbox" id="snapToggle" checked> Snap to Grid
                    </label>
                    <span id="canvasInfo">Canvas: 1200x800</span>
                    <!-- Zoom Controls (Added) -->
<div class="zoom-controls">
    <button class="zoom-btn" id="zoomInBtn" title="Zoom In (Ctrl + Wheel)">+</button>
    <button class="zoom-btn" id="zoomOutBtn" title="Zoom Out">-</button>
    <button class="zoom-btn active" id="zoomResetBtn" title="Reset Zoom (1x)">1x</button>
</div>
                </div>
                <div class="canvas-container">
                    <div class="canvas" id="canvas" role="application" aria-label="Canvas thiết kế" tabindex="0">
                        <!-- Blocks will be added here -->
                    </div>
                </div>
            </section>

            <!-- Right Panel -->
            <aside class="right-panel" role="complementary" aria-label="Bảng điều khiển">
                <!-- Add Content -->
                <section class="panel-section">
                    <div class="panel-header" role="button" tabindex="0" aria-expanded="true"
                        aria-controls="addContentPanel">
                        <span style="display: flex; align-items: center; gap: 12px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                <line x1="12" y1="8" x2="12" y2="16" />
                                <line x1="8" y1="12" x2="16" y2="12" />
                            </svg>
                            Add Content
                        </span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="6,9 12,15 18,9" />
                        </svg>
                    </div>
                    <div class="panel-content expanded" id="addContentPanel">
                        <div class="content-blocks" role="toolbar" aria-label="Khối nội dung">
                            <div class="content-block" draggable="true" data-type="text" tabindex="0" role="button"
                                aria-label="Thêm khối văn bản">
                                <div class="content-block-icon">
                                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <polyline points="4,7 4,4 20,4 20,7" />
                                        <line x1="9" y1="20" x2="15" y2="20" />
                                        <line x1="12" y1="4" x2="12" y2="20" />
                                    </svg>
                                </div>
                                <div class="content-block-name">Text</div>
                            </div>
                            <div class="content-block" draggable="true" data-type="image" tabindex="0" role="button"
                                aria-label="Thêm hình ảnh">
                                <div class="content-block-icon">
                                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                                        <circle cx="8.5" cy="8.5" r="1.5" />
                                        <polyline points="21,15 16,10 5,21" />
                                    </svg>
                                </div>
                                <div class="content-block-name">Image</div>
                            </div>
                            <div class="content-block" draggable="true" data-type="photogrid" tabindex="0" role="button"
                                aria-label="Thêm lưới ảnh">
                                <div class="content-block-icon">
                                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <rect x="3" y="3" width="7" height="7" />
                                        <rect x="14" y="3" width="7" height="7" />
                                        <rect x="14" y="14" width="7" height="7" />
                                        <rect x="3" y="14" width="7" height="7" />
                                    </svg>
                                </div>
                                <div class="content-block-name">Photo Grid</div>
                            </div>
                            <div class="content-block" draggable="true" data-type="video" tabindex="0" role="button"
                                aria-label="Thêm video">
                                <div class="content-block-icon">
                                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <polygon points="23,7 16,12 23,17" />
                                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2" />
                                    </svg>
                                </div>
                                <div class="content-block-name">Video</div>
                            </div>
                            <div class="content-block" draggable="true" data-type="embed" tabindex="0" role="button"
                                aria-label="Thêm embed">
                                <div class="content-block-icon">
                                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <polyline points="16,18 22,12 16,6" />
                                        <polyline points="8,6 2,12 8,18" />
                                    </svg>
                                </div>
                                <div class="content-block-name">Embed</div>
                            </div>
                            <div class="content-block" draggable="true" data-type="prototype" tabindex="0" role="button"
                                aria-label="Thêm prototype">
                                <div class="content-block-icon">
                                    <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                        stroke-width="2">
                                        <rect x="5" y="2" width="14" height="20" rx="2" ry="2" />
                                        <line x1="12" y1="18" x2="12.01" y2="18" />
                                    </svg>
                                </div>
                                <div class="content-block-name">Prototype</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Properties Inspector -->
                <section class="panel-section">
                    <div class="panel-header" role="button" tabindex="0" aria-expanded="true"
                        aria-controls="propertiesPanel">
                        <span style="display: flex; align-items: center; gap: 12px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <circle cx="12" cy="12" r="3" />
                                <path
                                    d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                            </svg>
                            Properties
                        </span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="6,9 12,15 18,9" />
                        </svg>
                    </div>
                    <div class="panel-content expanded" id="propertiesPanel">
                        <div id="propertiesForm">
                            <p style="color: #718096; font-size: 14px;">Chọn một khối để chỉnh sửa thuộc tính</p>
                        </div>
                    </div>
                </section>

                <!-- Layer View -->
                <section class="panel-section">
                    <div class="panel-header" role="button" tabindex="0" aria-expanded="true"
                        aria-controls="layersPanel">
                        <span style="display: flex; align-items: center; gap: 12px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <polygon points="12,2 2,7 12,12 22,7 12,2" />
                                <polyline points="2,17 12,22 22,17" />
                                <polyline points="2,12 12,17 22,12" />
                            </svg>
                            Layers
                        </span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="6,9 12,15 18,9" />
                        </svg>
                    </div>
                    <div class="panel-content expanded" id="layersPanel">
                        <div class="layer-list" id="layerList" role="list" aria-label="Danh sách lớp">
                            <!-- Layers will be populated here -->
                        </div>
                    </div>
                </section>

                <!-- Assets -->
                <section class="panel-section">
                    <div class="panel-header" role="button" tabindex="0" aria-expanded="false"
                        aria-controls="assetsPanel">
                        <span style="display: flex; align-items: center; gap: 12px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                            </svg>
                            Assets
                        </span>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <polyline points="9,18 15,12 9,6" />
                        </svg>
                    </div>
                    <div class="panel-content" id="assetsPanel">
                        <button class="btn" id="uploadAssetsBtn" style="width: 100%; margin-bottom: 16px;">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                <polyline points="17,8 12,3 7,8" />
                                <line x1="12" y1="3" x2="12" y2="15" />
                            </svg>
                            Upload Assets
                        </button>
                        <div class="asset-grid" id="assetGrid">
                            <!-- Assets will be populated here -->
                        </div>
                    </div>
                </section>
            </aside>
        </main>
    </div>

    <!-- Modals -->
    <!-- Upload Assets Modal -->
    <div class="modal" id="uploadModal" role="dialog" aria-labelledby="uploadModalTitle" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="uploadModalTitle">Upload Assets</h2>
                <button class="close-btn" aria-label="Đóng">&times;</button>
            </div>
            <div class="upload-area" id="uploadArea">
                <p>📁 Kéo thả file vào đây hoặc click để chọn</p>
                <p style="font-size: 12px; color: #666;">Hỗ trợ: JPG, PNG, GIF, MP4, MP3</p>
                <input type="file" id="fileInput" multiple accept="image/*,video/*,audio/*" style="display: none;">
            </div>
            <div class="asset-grid" id="modalAssetGrid">
                <!-- Uploaded assets preview -->
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal" role="dialog" aria-labelledby="exportModalTitle" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="exportModalTitle">Export Project</h2>
                <button class="close-btn" aria-label="Đóng">&times;</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 16px;">
                <button class="btn primary" id="exportHtmlBtn">📄 Export as HTML</button>
                <button class="btn" id="exportJsonBtn">📋 Export as JSON</button>
                <div>
                    <label for="embedCode">Embed Code:</label>
                    <textarea id="embedCode" rows="4" style="width: 100%; margin-top: 8px;" readonly></textarea>
                </div>
            </div>
        </div>
    </div>

    <!-- Preview Modal -->
    <!-- Preview Modal (Updated with device frames and better responsiveness) -->
<!-- Preview Modal (Fixed with auto-scaling) -->
<div class="modal" id="previewModal" role="dialog" aria-labelledby="previewModalTitle" aria-hidden="true">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title" id="previewModalTitle">Preview</h2>
            <button class="close-btn" aria-label="Đóng">&times;</button>
        </div>
        <div class="preview-container">
            <!-- Device Frame Container -->
            <div class="device-frame" id="deviceFrame">
                <div class="device-bezel">
                    <div class="device-screen">
                        <iframe id="previewFrame" class="preview-iframe"></iframe>
                    </div>
                </div>
            </div>
        </div>
        <div class="preview-controls">
            <div class="preview-size-buttons">
                <button class="btn active" data-preview-size="desktop" aria-label="Desktop view">🖥️ Desktop</button>
                <button class="btn" data-preview-size="tablet" aria-label="Tablet view">📱 Tablet</button>
                <button class="btn" data-preview-size="mobile" aria-label="Mobile view">📱 Mobile</button>
            </div>
            <button class="btn primary" id="fullscreenPreviewBtn">🔳 Fullscreen</button>
        </div>
    </div>
</div>

    <script>
        let zoomLevel = 1.0;
const minZoom = 0.5;
const maxZoom = 3.0;
        let isDirty = false; // Dirty flag for batch saves
        // Global State
        function normalizeColor(color) {
            if (!color) return '#000000';
            if (color.startsWith('rgba(')) {
                // Extract RGB from rgba, convert to hex (alpha ignored for picker)
                const match = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/);
                if (match) {
                    const toHex = (n) => `0${parseInt(n).toString(16)}`.slice(-2);
                    return `#${toHex(match[1])}${toHex(match[2])}${toHex(match[3])}`;
                }
            }
            if (color.startsWith('#') && color.length === 4) {
                // Expand shorthand #rgb to #rrggbb
                const r = color[1] + color[1], g = color[2] + color[2], b = color[3] + color[3];
                return `#${r}${g}${b}`;
            }
            return color; // Assume valid #rrggbb
        }

        // Updated hexToRgb to handle normalized colors
        function hexToRgb(hex) {
            hex = normalizeColor(hex); // Ensure full hex
            const result = /^#([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}` : '0, 0, 0';
        }
        let project = {
            id: 'project-' + Date.now(),
            title: 'Untitled Project',
            slug: 'untitled-project',
            styles: {
                global: {
                    fontFamily: 'Arial, sans-serif',
                    backgroundColor: '#ffffff',
                    textColor: '#333333'
                },
                breakpoints: {
                    desktop: { width: 1200 },
                    tablet: { width: 768 },
                    mobile: { width: 375 }
                }
            },
            blocks: [],
            assets: [],
            history: []
        };

        let currentBreakpoint = 'desktop';
        let selectedBlock = null;
        let draggedElement = null;
        let ghostElement = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let historyIndex = -1;
        let maxHistory = 50;
        let propertiesUpdateTimeout = null; // For debouncing properties updates
        let saveTimeout = null; // For debouncing save
        let resizeTimeout = null; // For resize handler

        // DOM Elements (cache for performance)
        const canvas = document.getElementById('canvas');
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');
        const snapToggle = document.getElementById('snapToggle');
        const layerList = document.getElementById('layerList');
        const propertiesForm = document.getElementById('propertiesForm');
        const uploadModal = document.getElementById('uploadModal');
        const exportModal = document.getElementById('exportModal');

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            initializeEventListeners();
            saveToHistory();
            updateUI();
        });

        function initializeEventListeners() {
            // Content blocks drag (use event delegation for better perf)
            const contentBlocksContainer = document.querySelector('.content-blocks');
            if (contentBlocksContainer) {
                contentBlocksContainer.addEventListener('dragstart', handleContentBlockDragStart, true);
                contentBlocksContainer.addEventListener('click', handleContentBlockClick, true);
                contentBlocksContainer.addEventListener('keydown', handleContentBlockKeydown, true);
            }

            // Canvas events
            if (canvas) {
                canvas.addEventListener('dragover', handleCanvasDragOver);
                canvas.addEventListener('drop', handleCanvasDrop);
                canvas.addEventListener('click', handleCanvasClick);
                canvas.addEventListener('keydown', handleCanvasKeydown);
            }

            // Undo/Redo
            if (undoBtn) undoBtn.addEventListener('click', undo);
            if (redoBtn) redoBtn.addEventListener('click', redo);

            // Responsive controls
            document.querySelectorAll('.responsive-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    document.querySelectorAll('.responsive-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentBreakpoint = this.dataset.breakpoint;
                    updateCanvasSize();
                });
            });
            // Zoom controls
const zoomInBtn = document.getElementById('zoomInBtn');
const zoomOutBtn = document.getElementById('zoomOutBtn');
const zoomResetBtn = document.getElementById('zoomResetBtn');
if (zoomInBtn) zoomInBtn.addEventListener('click', () => zoomCanvas(0.1));
if (zoomOutBtn) zoomOutBtn.addEventListener('click', () => zoomCanvas(-0.1));
if (zoomResetBtn) zoomResetBtn.addEventListener('click', resetZoom);

// Wheel zoom on canvas
if (canvas) {
    canvas.addEventListener('wheel', handleWheelZoom, { passive: false });
}

            // Panel toggles (event delegation)
            const rightPanel = document.querySelector('.right-panel');
            if (rightPanel) {
                rightPanel.addEventListener('click', handlePanelToggleClick);
                rightPanel.addEventListener('keydown', handlePanelToggleKeydown);
            }

            // Upload assets
            const uploadAssetsBtn = document.getElementById('uploadAssetsBtn');
            if (uploadAssetsBtn) {
                uploadAssetsBtn.addEventListener('click', () => {
                    if (uploadModal) {
                        uploadModal.classList.add('show');
                        uploadModal.setAttribute('aria-hidden', 'false');
                    }
                });
            }

            // Publish
            const publishBtn = document.getElementById('publishBtn');
            if (publishBtn) {
                publishBtn.addEventListener('click', () => {
                    if (exportModal) {
                        exportModal.classList.add('show');
                        exportModal.setAttribute('aria-hidden', 'false');
                        generateEmbedCode();
                    }
                });
            }

            // Modal close (event delegation)
            document.body.addEventListener('click', handleModalClose);

            // Setup functions
            setupUploadFunctionality();
            setupExportFunctionality();
            if (document.getElementById('previewBtn')) setupPreviewFunctionality();
            setupAdditionalFeatures();

            // Global keyboard shortcuts
            document.addEventListener('keydown', handleGlobalKeydown);

            // Optimized resize handler
            window.addEventListener('resize', handleResize);
        }

        // Delegated event handlers
        function handleContentBlockDragStart(e) {
    const block = e.target.closest('.content-block');
    if (!block) return;
    draggedElement = block;
    e.dataTransfer.setData('text/plain', block.dataset.type);
    createGhostElement(block);
}

        function handleContentBlockClick(e) {
            const block = e.target.closest('.content-block');
            if (!block) return;
            e.preventDefault();
            const blockType = block.dataset.type;
            const rect = canvas.getBoundingClientRect();
            const x = Math.max(0, (rect.width / 2) - 100);
            const y = Math.max(0, (rect.height / 2) - 50);
            addBlock(blockType, x, y);
        }

        function handleContentBlockKeydown(e) {
            const block = e.target.closest('.content-block');
            if (!block || (e.key !== 'Enter' && e.key !== ' ')) return;
            e.preventDefault();
            handleContentBlockClick.call(block, e);
        }

        function handlePanelToggleClick(e) {
            const header = e.target.closest('.panel-header');
            if (!header) return;
            e.preventDefault();
            togglePanel.call(header, e);
        }

        function handlePanelToggleKeydown(e) {
            const header = e.target.closest('.panel-header');
            if (!header || (e.key !== 'Enter' && e.key !== ' ')) return;
            e.preventDefault();
            togglePanel.call(header, e);
        }

        function handleModalClose(e) {
            if (e.target.classList.contains('close-btn') || e.target.classList.contains('modal')) {
                const modal = e.target.closest('.modal');
                if (modal) {
                    modal.classList.remove('show');
                    modal.setAttribute('aria-hidden', 'true');
                }
            }
        }

        function handleGlobalKeydown(e) {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'z':
                        e.preventDefault();
                        if (e.shiftKey) redo(); else undo();
                        break;
                    case 'y':
                        e.preventDefault();
                        redo();
                        break;
                }
            }
        }

        function handleResize() {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                updateCanvasSize();
                adjustMobileLayout();
            }, 100);
            resetZoom(); // Reset zoom khi thay view
        }

        function adjustMobileLayout() {
            if (window.innerWidth <= 968) {
                const rightPanel = document.querySelector('.right-panel');
                const canvasArea = document.querySelector('.canvas-area');
                if (rightPanel && canvasArea) {
                    const availableHeight = window.innerHeight;
                    if (availableHeight < 600) {
                        rightPanel.style.maxHeight = '35vh';
                        canvasArea.style.minHeight = '65vh';
                    } else {
                        rightPanel.style.maxHeight = '40vh';
                        canvasArea.style.minHeight = '60vh';
                    }
                }
            }
        }

        function createGhostElement(sourceElement) {
            if (ghostElement) removeGhostElement();
            ghostElement = document.createElement('div');
            ghostElement.className = 'ghost-block';
            ghostElement.innerHTML = sourceElement.innerHTML;
            document.body.appendChild(ghostElement);
            document.addEventListener('dragover', updateGhostPosition);
            document.addEventListener('dragend', removeGhostElement);
        }

        function updateGhostPosition(e) {
            if (ghostElement) {
                ghostElement.style.left = (e.clientX + 10) + 'px';
                ghostElement.style.top = (e.clientY + 10) + 'px';
            }
        }

        function removeGhostElement() {
            if (ghostElement) {
                document.body.removeChild(ghostElement);
                ghostElement = null;
            }
            document.removeEventListener('dragover', updateGhostPosition);
            document.removeEventListener('dragend', removeGhostElement);
        }

        function handleCanvasDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        }

        function handleCanvasDrop(e) {
            e.preventDefault();
            const blockType = e.dataTransfer.getData('text/plain');
            if (blockType) {
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                addBlock(blockType, x, y);
            }
            removeGhostElement();
        }

        function handleCanvasClick(e) {
            if (e.target === canvas) {
                selectedBlock = null;
                document.querySelectorAll('.canvas-block').forEach(el => el.classList.remove('selected'));
                updatePropertiesPanel();
                updateLayerSelection();
            }
        }

        function handleCanvasKeydown(e) {
            if (e.key === 'Delete' && selectedBlock) {
                deleteBlock(selectedBlock.id);
            }
        }

        function addBlock(type, x, y) {
            const block = {
                id: 'block-' + Date.now(),
                type: type,
                x: snapToggle?.checked ? Math.round(x / 20) * 20 : x,
                y: snapToggle?.checked ? Math.round(y / 20) * 20 : y,
                w: getDefaultWidth(type),
                h: getDefaultHeight(type),
                z: project.blocks.length,
                props: getDefaultProps(type)
            };

            project.blocks.push(block);
            requestAnimationFrame(() => renderBlock(block));
            selectBlock(block.id);
            debounceSaveToHistory();
            requestAnimationFrame(() => updateLayerList());
        }

        function getDefaultWidth(type) {
            const defaults = {
                text: 200,
                image: 200,
                photogrid: 300,
                video: 300,
                embed: 300,
                prototype: 250
            };
            return defaults[type] || 200;
        }

        function getDefaultHeight(type) {
            const defaults = {
                text: 100,
                image: 150,
                photogrid: 200,
                video: 200,
                embed: 200,
                prototype: 400
            };
            return defaults[type] || 100;
        }

        function getDefaultProps(type) {
            const defaults = {
                text: {
                    content: 'Nhập văn bản của bạn',
                    fontSize: 16,
                    color: '#333333',  // Fixed to full hex
                    fontWeight: 'normal',
                    textAlign: 'left',
                    lineHeight: '1.4'
                },
                image: {
                    src: '',
                    alt: 'Hình ảnh',
                    objectFit: 'cover',
                    opacity: 1,
                    borderRadius: 0,
                    overlay: false,
                    overlayColor: '#000000',  // Full hex
                    overlayText: ''
                },
                photogrid: {
                    images: [],
                    columns: 2,
                    gap: 4
                },
                video: {
                    src: '',
                    autoplay: false,
                    loop: false,
                    muted: false,
                    borderRadius: 0
                },
                embed: {
                    code: '<p>Embed code here</p>',
                    borderRadius: 0
                },
                prototype: {
                    src: '',
                    title: 'My Prototype',
                    borderRadius: 8
                }
            };
            return defaults[type] || {};
        }

        function renderBlock(block) {
            const blockElement = document.createElement('div');
            blockElement.className = 'canvas-block';
            blockElement.id = block.id;
            blockElement.style.left = block.x + 'px';
            blockElement.style.top = block.y + 'px';
            blockElement.style.width = block.w + 'px';
            blockElement.style.height = block.h + 'px';
            blockElement.style.zIndex = block.z;
            blockElement.tabIndex = 0;
            blockElement.setAttribute('role', 'button');
            blockElement.setAttribute('aria-label', `Khối ${block.type}`);

            const content = document.createElement('div');
            content.className = 'block-content';
            content.innerHTML = getBlockContent(block);  // FIX: Thêm dòng này
            blockElement.appendChild(content);

            const actions = document.createElement('div');
            actions.className = 'block-actions';
            actions.innerHTML = `
        <button class="block-action" title="Duplicate" aria-label="Nhân bản">⧉</button>
        <button class="block-action" title="Delete" aria-label="Xóa">🗑️</button>
        <button class="block-action" title="Bring Forward" aria-label="Đưa lên trước">↑</button>
        <button class="block-action" title="Send Backward" aria-label="Đưa ra sau">↓</button>
    `;
            blockElement.appendChild(actions);

            // Event listeners (giữ nguyên)
            blockElement.addEventListener('click', (e) => {
                e.stopPropagation();
                selectBlock(block.id);
            }, { passive: true });

            blockElement.addEventListener('mousedown', (e) => {
                if (e.target.classList.contains('block-action')) return;
                startDrag(e, block.id);
            }, { passive: true });

            blockElement.addEventListener('keydown', (e) => handleBlockKeydown(e, block.id));

            if (block.type === 'text') {
                content.addEventListener('dblclick', () => startTextEditing(block.id));
            }

            // Action buttons (giữ nguyên)
            const actionButtons = actions.querySelectorAll('.block-action');
            actionButtons[0].addEventListener('click', (e) => { e.stopPropagation(); duplicateBlock(block.id); });
            actionButtons[1].addEventListener('click', (e) => { e.stopPropagation(); deleteBlock(block.id); });
            actionButtons[2].addEventListener('click', (e) => { e.stopPropagation(); bringForward(block.id); });
            actionButtons[3].addEventListener('click', (e) => { e.stopPropagation(); sendBackward(block.id); });

            if (canvas) canvas.appendChild(blockElement);  // Thêm check canvas tồn tại
        }


        function selectBlock(blockId) {
            document.querySelectorAll('.canvas-block').forEach(el => el.classList.remove('selected'));
            const blockElement = document.getElementById(blockId);
            if (blockElement) {
                blockElement.classList.add('selected');
                selectedBlock = project.blocks.find(b => b.id === blockId);
                requestAnimationFrame(() => updatePropertiesPanel());
                requestAnimationFrame(() => updateLayerSelection());
            }
        }


        function updatePropertiesPanel() {
            if (!selectedBlock || !propertiesForm) {
                if (propertiesForm) propertiesForm.innerHTML = '<p style="color: #666; font-size: 14px;">Chọn một khối để chỉnh sửa thuộc tính</p>';
                return;
            }

            const form = document.createElement('form');
            form.className = 'properties-form';
            form.innerHTML = `
                <div class="form-group">
                    <label for="blockX">X Position</label>
                    <input type="number" id="blockX" value="${selectedBlock.x}" min="0">
                </div>
                <div class="form-group">
                    <label for="blockY">Y Position</label>
                    <input type="number" id="blockY" value="${selectedBlock.y}" min="0">
                </div>
                <div class="form-group">
                    <label for="blockW">Width</label>
                    <input type="number" id="blockW" value="${selectedBlock.w}" min="50">
                </div>
                <div class="form-group">
                    <label for="blockH">Height</label>
                    <input type="number" id="blockH" value="${selectedBlock.h}" min="30">
                </div>
                ${getTypeSpecificProperties(selectedBlock)}
            `;

            propertiesForm.innerHTML = '';
            propertiesForm.appendChild(form);

            form.addEventListener('input', debounceUpdateBlockProperties, { passive: true });
        }

        function getTypeSpecificProperties(block) {
            switch (block.type) {
                case 'text':
                    return `
                        <div class="form-group">
                            <label for="textContent">Content</label>
                            <textarea id="textContent" rows="3">${block.props.content}</textarea>
                        </div>
                        <div class="form-group">
                            <label for="fontSize">Font Size</label>
                            <input type="number" id="fontSize" value="${block.props.fontSize}" min="8" max="72">
                        </div>
                        <div class="form-group">
                            <label for="textColor">Color</label>
                            <input type="color" id="textColor" value="${normalizeColor(block.props.color)}">
                        </div>
                        <div class="form-group">
                            <label for="fontWeight">Font Weight</label>
                            <select id="fontWeight">
                                <option value="normal" ${block.props.fontWeight === 'normal' ? 'selected' : ''}>Normal</option>
                                <option value="bold" ${block.props.fontWeight === 'bold' ? 'selected' : ''}>Bold</option>
                                <option value="lighter" ${block.props.fontWeight === 'lighter' ? 'selected' : ''}>Light</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="textAlign">Text Align</label>
                            <select id="textAlign">
                                <option value="left" ${block.props.textAlign === 'left' ? 'selected' : ''}>Left</option>
                                <option value="center" ${block.props.textAlign === 'center' ? 'selected' : ''}>Center</option>
                                <option value="right" ${block.props.textAlign === 'right' ? 'selected' : ''}>Right</option>
                                <option value="justify" ${block.props.textAlign === 'justify' ? 'selected' : ''}>Justify</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="lineHeight">Line Height</label>
                            <input type="number" id="lineHeight" value="${block.props.lineHeight}" min="1" max="3" step="0.1">
                        </div>
                    `;
                case 'image':
                    return `
                        <div class="form-group">
                            <label for="imageSrc">Image URL</label>
                            <input type="url" id="imageSrc" value="${block.props.src}" placeholder="https://...">
                        </div>
                        <div class="form-group">
                            <label for="imageAlt">Alt Text</label>
                            <input type="text" id="imageAlt" value="${block.props.alt}">
                        </div>
                        <button type="button" class="btn" onclick="selectAssetForBlock('${block.id}')" style="width: 100%; margin-bottom: 12px;">📁 Chọn từ Assets</button>
                        <button type="button" class="btn" onclick="openImageUpload('${block.id}')" style="width: 100%; margin-bottom: 12px;">📷 Upload Ảnh Mới</button>
                        <div class="form-group">
                            <label for="objectFit">Object Fit</label>
                            <select id="objectFit">
                                <option value="cover" ${block.props.objectFit === 'cover' ? 'selected' : ''}>Cover</option>
                                <option value="contain" ${block.props.objectFit === 'contain' ? 'selected' : ''}>Contain</option>
                                <option value="fill" ${block.props.objectFit === 'fill' ? 'selected' : ''}>Fill</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="opacity">Opacity</label>
                            <input type="range" id="opacity" value="${block.props.opacity}" min="0" max="1" step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="borderRadius">Border Radius</label>
                            <input type="number" id="borderRadius" value="${block.props.borderRadius}" min="0" max="50">
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="overlay" ${block.props.overlay ? 'checked' : ''}> Show Overlay
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="overlayColor">Overlay Color</label>
                            <input type="color" id="overlayColor" value="${normalizeColor(block.props.overlayColor || '#000000')}">
                        </div>
                        <div class="form-group">
                            <label for="overlayText">Overlay Text</label>
                            <input type="text" id="overlayText" value="${block.props.overlayText}">
                        </div>
                    `;
                case 'photogrid':
                    return `
                        <div class="form-group">
                            <label for="gridColumns">Columns</label>
                            <select id="gridColumns">
                                <option value="1" ${block.props.columns === 1 ? 'selected' : ''}>1</option>
                                <option value="2" ${block.props.columns === 2 ? 'selected' : ''}>2</option>
                                <option value="3" ${block.props.columns === 3 ? 'selected' : ''}>3</option>
                                <option value="4" ${block.props.columns === 4 ? 'selected' : ''}>4</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="gridGap">Gap (px)</label>
                            <input type="number" id="gridGap" value="${block.props.gap}" min="0" max="20">
                        </div>
                        <button type="button" class="btn" onclick="openGridManager('${block.id}')" style="width: 100%;">🖼️ Quản lý ảnh</button>
                    `;
                case 'video':
                    return `
                        <div class="form-group">
                            <label for="videoSrc">Video URL</label>
                            <input type="url" id="videoSrc" value="${block.props.src}" placeholder="YouTube, Vimeo, hoặc file URL">
                        </div>
                        <button type="button" class="btn" onclick="openVideoUpload('${block.id}')" style="width: 100%; margin-bottom: 12px;">🎥 Upload Video</button>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="videoAutoplay" ${block.props.autoplay ? 'checked' : ''}> Autoplay
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="videoLoop" ${block.props.loop ? 'checked' : ''}> Loop
                            </label>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="videoMuted" ${block.props.muted ? 'checked' : ''}> Muted
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="videoBorderRadius">Border Radius</label>
                            <input type="number" id="videoBorderRadius" value="${block.props.borderRadius}" min="0" max="50">
                        </div>
                    `;
                case 'embed':
                    return `
                        <div class="form-group">
                            <label for="embedCode">Embed Code</label>
                            <textarea id="embedCode" rows="4" placeholder="Nhập HTML, iframe, hoặc script code">${block.props.code}</textarea>
                        </div>
                        <button type="button" class="btn" onclick="openEmbedEditor('${block.id}')" style="width: 100%; margin-bottom: 12px;">🔗 Embed Editor</button>
                        <div class="form-group">
                            <label for="embedBorderRadius">Border Radius</label>
                            <input type="number" id="embedBorderRadius" value="${block.props.borderRadius}" min="0" max="50">
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 8px;">
                            Hỗ trợ: YouTube, Vimeo, CodePen, Google Maps, Twitter, Instagram...
                        </div>
                    `;
                case 'prototype':
                    return `
                        <div class="form-group">
                            <label for="prototypeTitle">Title</label>
                            <input type="text" id="prototypeTitle" value="${block.props.title}">
                        </div>
                        <div class="form-group">
                            <label for="prototypeSrc">Prototype URL</label>
                            <input type="url" id="prototypeSrc" value="${block.props.src}" placeholder="Figma, InVision, Marvel...">
                        </div>
                        <button type="button" class="btn" onclick="openPrototypeEditor('${block.id}')" style="width: 100%; margin-bottom: 12px;">📱 Prototype Editor</button>
                        <div class="form-group">
                            <label for="prototypeBorderRadius">Border Radius</label>
                            <input type="number" id="prototypeBorderRadius" value="${block.props.borderRadius}" min="0" max="50">
                        </div>
                        <div style="font-size: 12px; color: #666; margin-top: 8px;">
                            Hỗ trợ: Figma, InVision, Marvel, Principle, Framer...
                        </div>
                    `;
                default:
                    return '';
            }
        }

        function debounceUpdateBlockProperties(e) {
            clearTimeout(propertiesUpdateTimeout);
            propertiesUpdateTimeout = setTimeout(() => updateBlockProperties(e), 150);
        }

        function updateBlockProperties(e) {
            if (!selectedBlock) return;

            // Update position and size
            selectedBlock.x = parseInt(document.getElementById('blockX')?.value) || 0;
            selectedBlock.y = parseInt(document.getElementById('blockY')?.value) || 0;
            selectedBlock.w = parseInt(document.getElementById('blockW')?.value) || 100;
            selectedBlock.h = parseInt(document.getElementById('blockH')?.value) || 60;

            // Update type-specific properties
            switch (selectedBlock.type) {
                case 'text':
                    selectedBlock.props.content = document.getElementById('textContent')?.value || '';
                    selectedBlock.props.fontSize = parseInt(document.getElementById('fontSize')?.value) || 16;
                    selectedBlock.props.color = document.getElementById('textColor')?.value || '#333333';
                    selectedBlock.props.fontWeight = document.getElementById('fontWeight')?.value || 'normal';
                    selectedBlock.props.textAlign = document.getElementById('textAlign')?.value || 'left';
                    selectedBlock.props.lineHeight = document.getElementById('lineHeight')?.value || '1.4';
                    break;
                case 'image':
                    selectedBlock.props.src = document.getElementById('imageSrc')?.value || '';
                    selectedBlock.props.alt = document.getElementById('imageAlt')?.value || '';
                    selectedBlock.props.objectFit = document.getElementById('objectFit')?.value || 'cover';
                    selectedBlock.props.opacity = parseFloat(document.getElementById('opacity')?.value) || 1;
                    selectedBlock.props.borderRadius = parseInt(document.getElementById('borderRadius')?.value) || 0;
                    selectedBlock.props.overlay = document.getElementById('overlay')?.checked || false;
                    selectedBlock.props.overlayColor = `rgba(${hexToRgb(document.getElementById('overlayColor')?.value || '#000000')}, 0.3)`;
                    selectedBlock.props.overlayText = document.getElementById('overlayText')?.value || '';
                    break;
                case 'photogrid':
                    selectedBlock.props.columns = parseInt(document.getElementById('gridColumns')?.value) || 2;
                    selectedBlock.props.gap = parseInt(document.getElementById('gridGap')?.value) || 4;
                    break;
                case 'video':
                    selectedBlock.props.src = document.getElementById('videoSrc')?.value || '';
                    selectedBlock.props.autoplay = document.getElementById('videoAutoplay')?.checked || false;
                    selectedBlock.props.loop = document.getElementById('videoLoop')?.checked || false;
                    selectedBlock.props.muted = document.getElementById('videoMuted')?.checked || false;
                    selectedBlock.props.borderRadius = parseInt(document.getElementById('videoBorderRadius')?.value) || 0;
                    break;
                case 'embed':
                    selectedBlock.props.code = document.getElementById('embedCode')?.value || '';
                    selectedBlock.props.borderRadius = parseInt(document.getElementById('embedBorderRadius')?.value) || 0;
                    break;
                case 'prototype':
                    selectedBlock.props.title = document.getElementById('prototypeTitle')?.value || '';
                    selectedBlock.props.src = document.getElementById('prototypeSrc')?.value || '';
                    selectedBlock.props.borderRadius = parseInt(document.getElementById('prototypeBorderRadius')?.value) || 8;
                    break;
            }

            requestAnimationFrame(() => updateBlockElement(selectedBlock));
            debounceSaveToHistory();
        }

        function updateBlockElement(block) {
            const element = document.getElementById(block.id);
            if (element) {
                element.style.left = block.x + 'px';
                element.style.top = block.y + 'px';
                element.style.width = block.w + 'px';
                element.style.height = block.h + 'px';
                element.style.zIndex = block.z;

                const content = element.querySelector('.block-content');
                if (content) content.innerHTML = getBlockContent(block);
            }
        }

        function startDrag(e, blockId) {
    if (e.target.classList.contains('block-action')) return;
    document.body.classList.add('dragging');
    const block = project.blocks.find(b => b.id === blockId);
    const element = document.getElementById(blockId);

    if (!block || !element) return;

    isDragging = true;
    element.classList.add('dragging');

    const rect = element.getBoundingClientRect();
    const canvasRect = canvas.getBoundingClientRect();

    dragOffset.x = e.clientX - rect.left;
    dragOffset.y = e.clientY - rect.top;

    let lastRaf = 0;

    function handleMouseMove(e) {
        if (!isDragging) return;
        const now = performance.now();
        if (now - lastRaf < 16) return; // Throttle to 60fps
        lastRaf = now;
        requestAnimationFrame(() => {
            const newX = e.clientX - canvasRect.left - dragOffset.x;
            const newY = e.clientY - canvasRect.top - dragOffset.y;

            block.x = snapToggle?.checked ? Math.round(newX / 20) * 20 : Math.max(0, newX);
            block.y = snapToggle?.checked ? Math.round(newY / 20) * 20 : Math.max(0, newY);

            element.style.left = block.x + 'px';
            element.style.top = block.y + 'px';

            if (selectedBlock && selectedBlock.id === blockId) {
                const xInput = document.getElementById('blockX');
                const yInput = document.getElementById('blockY');
                if (xInput) xInput.value = block.x;
                if (yInput) yInput.value = block.y;
            }
        });
    }

    function handleMouseUp() {
        isDragging = false;
        element.classList.remove('dragging');
        document.body.classList.remove('dragging');  // Chỉ remove ở đây
        document.removeEventListener('mousemove', handleMouseMove);
        document.removeEventListener('mouseup', handleMouseUp);
        debounceSaveToHistory();
    }

    document.addEventListener('mousemove', handleMouseMove);
    document.addEventListener('mouseup', handleMouseUp);
}

        function handleBlockKeydown(e, blockId) {
            const block = project.blocks.find(b => b.id === blockId);
            if (!block) return;

            const step = e.shiftKey ? 10 : 1;
            let moved = false;

            switch (e.key) {
                case 'ArrowLeft':
                    e.preventDefault();
                    block.x = Math.max(0, block.x - step);
                    moved = true;
                    break;
                case 'ArrowRight':
                    e.preventDefault();
                    block.x += step;
                    moved = true;
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    block.y = Math.max(0, block.y - step);
                    moved = true;
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    block.y += step;
                    moved = true;
                    break;
                case 'Delete':
                case 'Backspace':
                    e.preventDefault();
                    deleteBlock(blockId);
                    return;
                case 'Enter':
                    e.preventDefault();
                    if (block.type === 'text') startTextEditing(blockId);
                    return;
            }

            if (moved) {
                updateBlockElement(block);
                if (selectedBlock && selectedBlock.id === blockId) updatePropertiesPanel();
                debounceSaveToHistory();
            }
        }

        function startTextEditing(blockId) {
            const block = project.blocks.find(b => b.id === blockId);
            const element = document.getElementById(blockId);
            const textElement = element?.querySelector('.text-block');

            if (!block || !textElement) return;

            textElement.contentEditable = true;
            textElement.focus();

            const range = document.createRange();
            range.selectNodeContents(textElement);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);

            function finishEditing() {
                textElement.contentEditable = false;
                block.props.content = textElement.textContent;
                updatePropertiesPanel();
                debounceSaveToHistory();
            }

            const blurHandler = () => finishEditing();
            const keyHandler = (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    finishEditing();
                }
                if (e.key === 'Escape') {
                    textElement.textContent = block.props.content;
                    finishEditing();
                }
            };

            textElement.addEventListener('blur', blurHandler, { once: true });
            textElement.addEventListener('keydown', keyHandler);
        }

        function duplicateBlock(blockId) {
            const originalBlock = project.blocks.find(b => b.id === blockId);
            if (!originalBlock) return;

            const newBlock = {
                ...originalBlock,
                id: 'block-' + Date.now(),
                x: originalBlock.x + 20,
                y: originalBlock.y + 20,
                z: Math.max(...project.blocks.map(b => b.z)) + 1,
                props: { ...originalBlock.props }
            };

            project.blocks.push(newBlock);
            renderBlock(newBlock);
            selectBlock(newBlock.id);
            debounceSaveToHistory();
            updateLayerList();
        }

        function deleteBlock(blockId) {
            const element = document.getElementById(blockId);
            if (element) element.remove();

            project.blocks = project.blocks.filter(b => b.id !== blockId);

            if (selectedBlock && selectedBlock.id === blockId) {
                selectedBlock = null;
                updatePropertiesPanel();
            }

            debounceSaveToHistory();
            requestAnimationFrame(() => updateLayerList());
        }

        function bringForward(blockId) {
            const block = project.blocks.find(b => b.id === blockId);
            if (!block) return;

            const maxZ = Math.max(...project.blocks.map(b => b.z));
            if (block.z < maxZ) {
                block.z += 1;
                updateBlockElement(block);
                debounceSaveToHistory();
                updateLayerList();
            }
        }

        function sendBackward(blockId) {
            const block = project.blocks.find(b => b.id === blockId);
            if (!block) return;

            const minZ = Math.min(...project.blocks.map(b => b.z));
            if (block.z > minZ) {
                block.z -= 1;
                updateBlockElement(block);
                debounceSaveToHistory();
                updateLayerList();
            }
        }

        function updateLayerList() {
            if (!layerList) return;
            const sortedBlocks = [...project.blocks].sort((a, b) => b.z - a.z);
            const fragment = document.createDocumentFragment();

            sortedBlocks.forEach(block => {
                const item = document.createElement('div');
                item.className = `layer-item ${selectedBlock && selectedBlock.id === block.id ? 'selected' : ''}`;
                item.dataset.blockId = block.id;
                item.setAttribute('role', 'listitem');
                item.innerHTML = `
                    <div class="layer-info">
                        <span>${getBlockIcon(block.type)}</span>
                        <span>${block.type} ${block.id.split('-')[1]}</span>
                    </div>
                    <div class="layer-actions">
                        <button class="layer-action" title="Hide/Show" aria-label="Ẩn/Hiện">👁️</button>
                        <button class="layer-action" title="Lock/Unlock" aria-label="Khóa/Mở khóa">🔒</button>
                    </div>
                `;
                item.addEventListener('click', () => selectBlock(block.id));
                fragment.appendChild(item);
            });

            layerList.innerHTML = '';
            layerList.appendChild(fragment);
        }

        function updateLayerSelection() {
            if (!layerList) return;
            layerList.querySelectorAll('.layer-item').forEach(item => {
                item.classList.toggle('selected', selectedBlock && item.dataset.blockId === selectedBlock.id);
            });
        }

        function getBlockIcon(type) {
            const icons = {
                text: '📝',
                image: '🖼️',
                photogrid: '🖼️',
                video: '🎥',
                embed: '🔗',
                prototype: '📱'
            };
            return icons[type] || '📦';
        }

        function togglePanel(e) {
            const header = e.target.closest('.panel-header');
            if (!header) return;
            const content = header.nextElementSibling;
            if (!content) return;
            const arrow = header.querySelector('svg:last-child') || header.querySelector('span:last-child');

            const isExpanded = content.classList.contains('expanded');

            if (isExpanded) {
                content.classList.remove('expanded');
                content.style.maxHeight = '280px';
                if (arrow) {
                    if (arrow.tagName === 'svg') {
                        arrow.style.transform = 'rotate(-90deg)';
                    } else {
                        arrow.textContent = '▶';
                    }
                }
                header.setAttribute('aria-expanded', 'false');
            } else {
                content.classList.add('expanded');
                content.style.maxHeight = 'none';
                if (arrow) {
                    if (arrow.tagName === 'svg') {
                        arrow.style.transform = 'rotate(0deg)';
                    } else {
                        arrow.textContent = '▼';
                    }
                }
                header.setAttribute('aria-expanded', 'true');
            }
        }

        function updateCanvasSize() {
            requestAnimationFrame(() => {
                const sizes = {
                    desktop: { width: '1200px', height: '800px' },
                    tablet: { width: '768px', height: '1024px' },
                    mobile: { width: '375px', height: '667px' }
                };

                const size = sizes[currentBreakpoint];
                const canvasContainer = document.querySelector('.canvas-container');

                // Responsive canvas sizing
                if (window.innerWidth <= 768) {
                    canvas.style.width = '100%';
                    canvas.style.height = 'auto';
                    canvas.style.minWidth = '100%';
                    canvas.style.minHeight = '400px';
                    if (canvasContainer) {
                        canvasContainer.style.aspectRatio = currentBreakpoint === 'mobile' ? '9/16' : '3/4';
                    }
                } else {
                    canvas.style.width = size.width;
                    canvas.style.height = size.height;
                    canvas.style.minWidth = size.width;
                    canvas.style.minHeight = size.height;
                    if (canvasContainer) canvasContainer.style.aspectRatio = 'auto';
                }
                updateCanvasInfo();
            });
        }

        function updateCanvasInfo() {
            const sizes = {
                desktop: { width: '1200px', height: '800px' },
                tablet: { width: '768px', height: '1024px' },
                mobile: { width: '375px', height: '667px' }
            };
            const size = sizes[currentBreakpoint];
            const snapStatus = snapToggle?.checked ? ' • Snap ON' : ' • Snap OFF';
            const canvasInfo = document.getElementById('canvasInfo');
            if (canvasInfo) {
                canvasInfo.textContent = `Canvas: ${size.width.replace('px', '')} x ${size.height.replace('px', '')} (${currentBreakpoint})${snapStatus}`;
            }
        }

        // History Management
        function debounceSaveToHistory() {
    isDirty = true;  // Set flag nếu chưa set
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(() => {
        if (isDirty) saveToHistory();
        isDirty = false;
    }, 500);
}

function saveToHistory() {
    const state = JSON.parse(JSON.stringify(project));
    if (historyIndex < project.history.length - 1) {
        project.history = project.history.slice(0, historyIndex + 1);
    }
    // Avoid duplicate if same as last
    const lastState = project.history[historyIndex];
    if (!lastState || JSON.stringify(lastState.blocks) !== JSON.stringify(state.blocks)) {
        project.history.push(state);
        if (project.history.length > maxHistory) {
            project.history.shift();
        } else {
            historyIndex++;
        }

        updateHistoryButtons();
        localStorage.setItem('portfolio-project', JSON.stringify(project));
    }
}

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                restoreFromHistory();
            }
        }

        function redo() {
            if (historyIndex < project.history.length - 1) {
                historyIndex++;
                restoreFromHistory();
            }
        }

        function restoreFromHistory() {
    const state = project.history[historyIndex];
    if (!state) return;
    project.blocks = JSON.parse(JSON.stringify(state.blocks));
    project.assets = JSON.parse(JSON.stringify(state.assets));
    // Clear canvas efficiently
    while (canvas.firstChild) canvas.removeChild(canvas.firstChild);
    project.blocks.forEach(block => renderBlock(block));

    selectedBlock = null;
    updatePropertiesPanel();
    updateLayerList();
    updateHistoryButtons();
}

        function updateHistoryButtons() {
            if (undoBtn) undoBtn.disabled = historyIndex <= 0;
            if (redoBtn) redoBtn.disabled = historyIndex >= project.history.length - 1;
        }

        // Upload Functionality
        function setupUploadFunctionality() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const modalAssetGrid = document.getElementById('modalAssetGrid');

            if (!uploadArea || !fileInput || !modalAssetGrid) return;

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFiles(e.dataTransfer.files);
            });

            fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

            function handleFiles(files) {
                Array.from(files).forEach(file => {
                    if (file.type.startsWith('image/') || file.type.startsWith('video/') || file.type.startsWith('audio/')) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            const asset = {
                                id: 'asset-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                                name: file.name,
                                type: file.type.split('/')[0],
                                dataURL: e.target.result,
                                tags: []
                            };

                            project.assets.push(asset);
                            renderAssetInModal(asset);
                            updateAssetGrid();
                            debounceSaveToHistory();
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            function renderAssetInModal(asset) {
                const assetElement = document.createElement('div');
                assetElement.className = 'asset-item';
                assetElement.innerHTML = asset.type === 'image' ?
                    `<img src="${asset.dataURL}" alt="${asset.name}">` :
                    `<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f0f0f0;">
                        ${asset.type === 'video' ? '🎥' : '🎵'}
                    </div>`;

                modalAssetGrid.appendChild(assetElement);
            }
        }

        function updateAssetGrid() {
            const assetGrid = document.getElementById('assetGrid');
            if (!assetGrid) return;
            const fragment = document.createDocumentFragment();

            project.assets.forEach(asset => {
                const item = document.createElement('div');
                item.className = 'asset-item';
                item.dataset.assetId = asset.id;
                item.innerHTML = asset.type === 'image' ?
                    `<img src="${asset.dataURL}" alt="${asset.name}">` :
                    `<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f0f0f0; font-size: 24px;">
                        ${asset.type === 'video' ? '🎥' : '🎵'}
                    </div>`;
                item.addEventListener('click', () => {
                    const selectedAsset = project.assets.find(a => a.id === asset.id);
                    if (selectedAsset && selectedBlock) applyAssetToBlock(selectedAsset, selectedBlock);
                }, { passive: true });
                fragment.appendChild(item);
            });

            assetGrid.innerHTML = '';
            assetGrid.appendChild(fragment);
        }

        function selectAssetForBlock(blockId) {
            const customModal = document.createElement('div');
            customModal.className = 'modal show';
            customModal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Chọn Asset</h2>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div class="asset-grid" id="selectAssetGrid">
                        ${project.assets.map(asset => `
                        <div class="asset-item" data-asset-id="${asset.id}">
                            ${asset.type === 'image' ?
                    `<img src="${asset.dataURL}" alt="${asset.name}">` :
                    `<div style="display: flex; align-items: center; justify-content: center; height: 100%; background: #f0f0f0; font-size: 24px;">
                                ${asset.type === 'video' ? '🎥' : '🎵'}
                            </div>`
                }
                        </div>
                        `).join('')}
                    </div>
                </div>
            `;

            document.body.appendChild(customModal);

            customModal.querySelector('.close-btn').addEventListener('click', () => customModal.remove());

            customModal.querySelectorAll('.asset-item').forEach(item => {
                item.addEventListener('click', () => {
                    const assetId = item.dataset.assetId;
                    const asset = project.assets.find(a => a.id === assetId);
                    const block = project.blocks.find(b => b.id === blockId);
                    if (asset && block) {
                        applyAssetToBlock(asset, block);
                        updatePropertiesPanel();
                        updateBlockElement(block);
                        debounceSaveToHistory();
                    }
                    customModal.remove();
                });
            });
        }

        function applyAssetToBlock(asset, block) {
            switch (block.type) {
                case 'image':
                    if (asset.type === 'image') {
                        block.props.src = asset.dataURL;
                        block.props.alt = asset.name;
                    }
                    break;
                case 'video':
                    if (asset.type === 'video') {
                        block.props.src = asset.dataURL;
                    }
                    break;
            }
        }
        function getBlockContent(block) {
            switch (block.type) {
                case 'text':
                    return `<div class="text-block" style="font-size: ${block.props.fontSize}px; color: ${normalizeColor(block.props.color)}; font-weight: ${block.props.fontWeight || 'normal'}; text-align: ${block.props.textAlign || 'left'}; line-height: ${block.props.lineHeight || '1.4'}; padding: 8px;">${block.props.content}</div>`;
                case 'image':
                    if (block.props.src) {
                        return `<div style="width: 100%; height: 100%; position: relative; overflow: hidden; border-radius: ${block.props.borderRadius || 0}px;">
                    <img src="${block.props.src}" alt="${block.props.alt}" style="width: 100%; height: 100%; object-fit: ${block.props.objectFit || 'cover'}; opacity: ${block.props.opacity || 1};">
                    ${block.props.overlay ? `<div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: ${block.props.overlayColor || 'rgba(0,0,0,0.3)'}; display: flex; align-items: center; justify-content: center; color: white; font-size: 14px;">${block.props.overlayText || ''}</div>` : ''}
                </div>`;
                    } else {
                        return `<div class="upload-placeholder" style="background: #f0f0f0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; cursor: pointer; border: 2px dashed #ddd; border-radius: 8px;" onclick="openImageUpload('${block.id}')">
                    <div style="font-size: 48px; margin-bottom: 8px;">📷</div>
                    <div>Click để upload ảnh</div>
                    <div style="font-size: 12px; margin-top: 4px;">hoặc kéo thả file vào đây</div>
                </div>`;
                    }
                case 'photogrid':
                    const gridImages = block.props.images || [];
                    const totalSlots = block.props.columns * Math.ceil(4 / block.props.columns);
                    return `<div style="display: grid; grid-template-columns: repeat(${block.props.columns}, 1fr); gap: 4px; height: 100%;">
                ${Array(totalSlots).fill(0).map((_, index) => {
                        const image = gridImages[index];
                        return image ?
                            `<div style="background: url('${image.src}') center/cover; aspect-ratio: 1; border-radius: 4px; position: relative; cursor: pointer;" onclick="editGridImage('${block.id}', ${index})">
                            <div style="position: absolute; top: 4px; right: 4px; background: rgba(0,0,0,0.7); color: white; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 12px; cursor: pointer;" onclick="removeGridImage('${block.id}', ${index}); event.stopPropagation();">×</div>
                        </div>` :
                            `<div style="background: #f0f0f0; aspect-ratio: 1; display: flex; align-items: center; justify-content: center; color: #666; border: 2px dashed #ddd; border-radius: 4px; cursor: pointer; font-size: 24px;" onclick="addGridImage('${block.id}', ${index})">+</div>`;
                    }).join('')}
            </div>`;
                case 'video':
                    if (block.props.src) {
                        if (block.props.src.includes('youtube.com') || block.props.src.includes('youtu.be')) {
                            const videoId = extractYouTubeId(block.props.src);
                            return `<iframe src="https://www.youtube.com/embed/${videoId}${block.props.autoplay ? '?autoplay=1' : ''}" frameborder="0" allowfullscreen style="width: 100%; height: 100%; border-radius: ${block.props.borderRadius || 0}px;"></iframe>`;
                        } else if (block.props.src.includes('vimeo.com')) {
                            const videoId = block.props.src.split('/').pop();
                            return `<iframe src="https://player.vimeo.com/video/${videoId}${block.props.autoplay ? '?autoplay=1' : ''}" frameborder="0" allowfullscreen style="width: 100%; height: 100%; border-radius: ${block.props.borderRadius || 0}px;"></iframe>`;
                        } else {
                            return `<video ${block.props.autoplay ? 'autoplay' : ''} ${block.props.loop ? 'loop' : ''} ${block.props.muted ? 'muted' : ''} controls style="width: 100%; height: 100%; object-fit: cover; border-radius: ${block.props.borderRadius || 0}px;">
                        <source src="${block.props.src}" type="video/mp4">
                        Trình duyệt không hỗ trợ video.
                    </video>`;
                        }
                    } else {
                        return `<div class="upload-placeholder" style="background: #f0f0f0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; cursor: pointer; border: 2px dashed #ddd; border-radius: 8px;" onclick="openVideoUpload('${block.id}')">
                    <div style="font-size: 48px; margin-bottom: 8px;">🎥</div>
                    <div>Click để upload video</div>
                    <div style="font-size: 12px; margin-top: 4px;">hoặc nhập YouTube/Vimeo URL</div>
                </div>`;
                    }
                case 'embed':
                    if (block.props.code && block.props.code.trim() !== '<p>Embed code here</p>') {
                        return `<div style="width: 100%; height: 100%; overflow: hidden; border-radius: ${block.props.borderRadius || 0}px;">
                    <iframe srcdoc="${block.props.code.replace(/"/g, '&quot;')}" style="width: 100%; height: 100%; border: none;" sandbox="allow-scripts allow-same-origin"></iframe>
                </div>`;
                    } else {
                        return `<div class="embed-placeholder" style="background: #f8f9fa; padding: 16px; border: 2px dashed #ddd; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #666; cursor: pointer; border-radius: 8px;" onclick="openEmbedEditor('${block.id}')">
                    <div style="font-size: 48px; margin-bottom: 8px;">🔗</div>
                    <div>Click để thêm embed code</div>
                    <div style="font-size: 12px; margin-top: 4px;">HTML, iframe, hoặc script</div>
                </div>`;
                    }
                case 'prototype':
                    if (block.props.src) {
                        return `<div style="width: 100%; height: 100%; border-radius: ${block.props.borderRadius || 8}px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <iframe src="${block.props.src}" style="width: 100%; height: 100%; border: none;" title="${block.props.title}"></iframe>
                </div>`;
                    } else {
                        return `<div class="prototype-placeholder" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; cursor: pointer; border-radius: 8px; position: relative;" onclick="openPrototypeEditor('${block.id}')">
                    <div style="font-size: 48px; margin-bottom: 12px;">📱</div>
                    <div style="font-size: 18px; font-weight: 600; margin-bottom: 4px;">${block.props.title}</div>
                    <div style="font-size: 12px; opacity: 0.8;">Click để thêm prototype link</div>
                    <div style="position: absolute; bottom: 8px; right: 8px; font-size: 10px; opacity: 0.6;">Prototype</div>
                </div>`;
                    }
                default:
                    return `<div>${block.type}</div>`;
            }
        }
        // Export Functionality
        function setupExportFunctionality() {
            const exportHtmlBtn = document.getElementById('exportHtmlBtn');
            const exportJsonBtn = document.getElementById('exportJsonBtn');
            if (exportHtmlBtn) exportHtmlBtn.addEventListener('click', exportAsHTML);
            if (exportJsonBtn) exportJsonBtn.addEventListener('click', exportAsJSON);
        }

        function exportAsHTML() {
            const htmlContent = generateHTMLExport ? generateHTMLExport(project) : '';  // Assume global or from export.js
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${project.slug}.html`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function exportAsJSON() {
            const jsonContent = JSON.stringify(project, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${project.slug}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function generateEmbedCode() {
            const embedCodeEl = document.getElementById('embedCode');
            if (!embedCodeEl) return;
            const htmlContent = generateHTMLExport ? generateHTMLExport(project) : '';  // FIX: Thêm param + check tồn tại (nếu file riêng chưa load)
            const embedCode = `<iframe src="data:text/html;base64,${btoa(htmlContent)}" width="1200" height="800" frameborder="0"></iframe>`;
            embedCodeEl.value = embedCode;
        }

        function updateUI() {
            updateLayerList();
            updateAssetGrid();
            updateHistoryButtons();
            updateCanvasSize();
        }

        // Utility Functions
        function extractYouTubeId(url) {
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|&v=)([^#&?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : null;
        }

        // Upload and Editor Functions
        function openImageUpload(blockId) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const block = project.blocks.find(b => b.id === blockId);
                        if (block) {
                            block.props.src = e.target.result;
                            block.props.alt = file.name;
                            updateBlockElement(block);
                            if (selectedBlock && selectedBlock.id === blockId) updatePropertiesPanel();
                            debounceSaveToHistory();
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function openVideoUpload(blockId) {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Upload Video</h2>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div class="form-group">
                            <label>Video URL (YouTube, Vimeo)</label>
                            <input type="url" id="videoUrlInput" placeholder="https://youtube.com/watch?v=...">
                            <button class="btn" onclick="setVideoUrl('${blockId}')">Sử dụng URL</button>
                        </div>
                        <div style="text-align: center; margin: 16px 0;">hoặc</div>
                        <div class="upload-area" onclick="selectVideoFile('${blockId}')">
                            <p>📁 Click để chọn file video</p>
                            <p style="font-size: 12px; color: #666;">MP4, WebM, OGV</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.close-btn').addEventListener('click', () => modal.remove());

            window.setVideoUrl = function (blockId) {
                const url = document.getElementById('videoUrlInput')?.value || '';
                const block = project.blocks.find(b => b.id === blockId);
                if (block && url) {
                    block.props.src = url;
                    updateBlockElement(block);
                    if (selectedBlock && selectedBlock.id === blockId) updatePropertiesPanel();
                    debounceSaveToHistory();
                    modal.remove();
                }
            };

            window.selectVideoFile = function (blockId) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'video/*';
                input.onchange = function (e) {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            const block = project.blocks.find(b => b.id === blockId);
                            if (block) {
                                block.props.src = e.target.result;
                                updateBlockElement(block);
                                if (selectedBlock && selectedBlock.id === blockId) updatePropertiesPanel();
                                debounceSaveToHistory();
                                modal.remove();
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                };
                input.click();
            };
        }

        function openEmbedEditor(blockId) {
            const block = project.blocks.find(b => b.id === blockId);
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Embed Editor</h2>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div class="form-group">
                            <label>Embed Code</label>
                            <textarea id="embedCodeEditor" rows="8" placeholder="Nhập HTML, iframe, hoặc script code...">${block ? block.props.code : ''}</textarea>
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            <strong>Ví dụ:</strong><br>
                            • YouTube: &lt;iframe src="https://youtube.com/embed/VIDEO_ID"&gt;&lt;/iframe&gt;<br>
                            • CodePen: &lt;iframe src="https://codepen.io/user/embed/pen-id"&gt;&lt;/iframe&gt;<br>
                            • Google Maps: &lt;iframe src="https://maps.google.com/..."&gt;&lt;/iframe&gt;
                        </div>
                        <button class="btn primary" onclick="saveEmbedCode('${blockId}')">Lưu</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.close-btn').addEventListener('click', () => modal.remove());

            window.saveEmbedCode = function (blockId) {
                const code = document.getElementById('embedCodeEditor')?.value || '';
                const block = project.blocks.find(b => b.id === blockId);
                if (block) {
                    block.props.code = code;
                    updateBlockElement(block);
                    if (selectedBlock && selectedBlock.id === blockId) updatePropertiesPanel();
                    debounceSaveToHistory();
                    modal.remove();
                }
            };
        }

        function openPrototypeEditor(blockId) {
            const block = project.blocks.find(b => b.id === blockId);
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Prototype Editor</h2>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" id="prototypeEditorTitle" value="${block ? block.props.title : ''}" placeholder="My Prototype">
                        </div>
                        <div class="form-group">
                            <label>Prototype URL</label>
                            <input type="url" id="prototypeEditorUrl" value="${block ? block.props.src : ''}" placeholder="https://figma.com/proto/...">
                        </div>
                        <div style="font-size: 12px; color: #666;">
                            <strong>Hỗ trợ:</strong><br>
                            • Figma: https://figma.com/proto/...<br>
                            • InVision: https://invis.io/...<br>
                            • Marvel: https://marvelapp.com/prototype/...<br>
                            • Framer: https://framer.com/share/...
                        </div>
                        <button class="btn primary" onclick="savePrototype('${blockId}')">Lưu</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.close-btn').addEventListener('click', () => modal.remove());

            window.savePrototype = function (blockId) {
                const title = document.getElementById('prototypeEditorTitle')?.value || '';
                const url = document.getElementById('prototypeEditorUrl')?.value || '';
                const block = project.blocks.find(b => b.id === blockId);
                if (block) {
                    block.props.title = title;
                    block.props.src = url;
                    updateBlockElement(block);
                    if (selectedBlock && selectedBlock.id === blockId) updatePropertiesPanel();
                    debounceSaveToHistory();
                    modal.remove();
                }
            };
        }

        function openGridManager(blockId) {
            const block = project.blocks.find(b => b.id === blockId);
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Photo Grid Manager</h2>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <button class="btn" onclick="addGridImages('${blockId}')">📁 Thêm ảnh</button>
                        <div class="asset-grid" id="gridManagerGrid">
                            ${(block?.props.images || []).map((img, index) => `
                            <div class="asset-item" style="position: relative;">
                                <img src="${img.src}" alt="${img.alt}">
                                <button style="position: absolute; top: 4px; right: 4px; background: rgba(255,0,0,0.8); color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer;" onclick="removeGridImageFromManager('${blockId}', ${index})">×</button>
                            </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.close-btn').addEventListener('click', () => modal.remove());

            window.addGridImages = function (blockId) {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = 'image/*';
                input.multiple = true;
                input.onchange = function (e) {
                    const files = Array.from(e.target.files);
                    const block = project.blocks.find(b => b.id === blockId);
                    if (block) {
                        files.forEach(file => {
                            const reader = new FileReader();
                            reader.onload = function (e) {
                                if (!block.props.images) block.props.images = [];
                                block.props.images.push({
                                    src: e.target.result,
                                    alt: file.name
                                });
                                updateBlockElement(block);
                                debounceSaveToHistory();
                                modal.remove();
                                openGridManager(blockId);
                            };
                            reader.readAsDataURL(file);
                        });
                    }
                };
                input.click();
            };

            window.removeGridImageFromManager = function (blockId, index) {
                const block = project.blocks.find(b => b.id === blockId);
                if (block && block.props.images) {
                    block.props.images.splice(index, 1);
                    updateBlockElement(block);
                    debounceSaveToHistory();
                    modal.remove();
                    openGridManager(blockId);
                }
            };
        }

        function addGridImage(blockId, index) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const block = project.blocks.find(b => b.id === blockId);
                        if (block) {
                            if (!block.props.images) block.props.images = [];
                            block.props.images[index] = {
                                src: e.target.result,
                                alt: file.name
                            };
                            updateBlockElement(block);
                            debounceSaveToHistory();
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        function removeGridImage(blockId, index) {
            const block = project.blocks.find(b => b.id === blockId);
            if (block && block.props.images) {
                block.props.images.splice(index, 1);
                updateBlockElement(block);
                debounceSaveToHistory();
            }
        }

        function editGridImage(blockId, index) {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = function (e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        const block = project.blocks.find(b => b.id === blockId);
                        if (block && block.props.images && block.props.images[index]) {
                            block.props.images[index] = {
                                src: e.target.result,
                                alt: file.name
                            };
                            updateBlockElement(block);
                            debounceSaveToHistory();
                        }
                    };
                    reader.readAsDataURL(file);
                }
            };
            input.click();
        }

        // Preview Functionality
        function setupPreviewFunctionality() {
    const previewBtn = document.getElementById('previewBtn');
    if (!previewBtn) return;
    previewBtn.addEventListener('click', openPreview);

    // Preview size controls (Fixed: Use style and auto-scale)
    document.querySelectorAll('[data-preview-size]').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('[data-preview-size]').forEach(b => b.classList.remove('active'));
            this.classList.add('active');

            const previewFrame = document.getElementById('previewFrame');
            const deviceFrame = document.getElementById('deviceFrame');
            if (!previewFrame || !deviceFrame) return;

            const size = this.dataset.previewSize;
            const sizes = {
                desktop: { width: '1200px', height: '800px' },
                tablet: { width: '768px', height: '1024px' },
                mobile: { width: '375px', height: '667px' }
            };

            const dimensions = sizes[size];
            previewFrame.style.width = dimensions.width;
            previewFrame.style.height = dimensions.height;

            // Add device class for bezel
            deviceFrame.className = `device-frame device-size-${size}`;

            // Auto-scale if frame overflows container
            setTimeout(() => autoScalePreview(deviceFrame, previewFrame), 100);
        });
    });

    // Fullscreen preview (Fullscreen modal)
    const fullscreenPreviewBtn = document.getElementById('fullscreenPreviewBtn');
    if (fullscreenPreviewBtn) {
        fullscreenPreviewBtn.addEventListener('click', function() {
            const previewModal = document.getElementById('previewModal');
            if (!previewModal) return;
            if (previewModal.requestFullscreen) {
                previewModal.requestFullscreen();
            } else if (previewModal.webkitRequestFullscreen) {
                previewModal.webkitRequestFullscreen();
            } else if (previewModal.msRequestFullscreen) {
                previewModal.msRequestFullscreen();
            }
        });
    }

    // Handle window resize to re-scale preview
    window.addEventListener('resize', () => {
        const deviceFrame = document.getElementById('deviceFrame');
        const previewFrame = document.getElementById('previewFrame');
        if (deviceFrame && previewFrame) {
            autoScalePreview(deviceFrame, previewFrame);
        }
    });
}

function autoScalePreview(deviceFrame, previewFrame) {
    const container = deviceFrame.parentElement;
    if (!container) return;

    const containerRect = container.getBoundingClientRect();
    const frameRect = deviceFrame.getBoundingClientRect();
    const scaleX = containerRect.width / frameRect.width;
    const scaleY = containerRect.height / frameRect.height;
    const scale = Math.min(scaleX, scaleY, 1); // Never scale up

    if (scale < 0.9) {
        deviceFrame.classList.add('scaled');
        deviceFrame.style.transform = `scale(${scale})`;
    } else {
        deviceFrame.classList.remove('scaled');
        deviceFrame.style.transform = 'scale(1)';
    }
}

function openPreview() {
    const previewModal = document.getElementById('previewModal');
    const previewFrame = document.getElementById('previewFrame');
    const deviceFrame = document.getElementById('deviceFrame');
    if (!previewModal || !previewFrame || !deviceFrame) return;

    try {
        const previewHTML = generateHTMLExport ? generateHTMLExport(project) : '';
        const blob = new Blob([previewHTML], { type: 'text/html' });
        const url = URL.createObjectURL(blob);

        previewFrame.src = url;
        previewModal.classList.add('show');
        previewModal.setAttribute('aria-hidden', 'false');

        // Default to desktop and auto-scale
        document.querySelector('[data-preview-size="desktop"]').click();

        const closeHandler = (e) => {
            if (e.target === previewModal || e.target.classList.contains('close-btn')) {
                URL.revokeObjectURL(url);
                previewModal.classList.remove('show');
                previewModal.setAttribute('aria-hidden', 'true');
                previewModal.removeEventListener('click', closeHandler);
                // Exit fullscreen
                if (document.exitFullscreen) document.exitFullscreen();
                else if (document.webkitExitFullscreen) document.webkitExitFullscreen();
                else if (document.msExitFullscreen) document.msExitFullscreen();
            }
        };
        previewModal.addEventListener('click', closeHandler);
    } catch (e) {
        showNotification('Preview failed: Project too large. Try exporting JSON instead.');
        return;
    }
}

        // Additional Features
        function setupAdditionalFeatures() {
            createAutoSaveIndicator();
            setupKeyboardShortcuts();
            if (document.querySelector('.header-left')) setupProjectTemplates();
            setupAdvancedExport();
            setupCollaboration();
        }

        function createAutoSaveIndicator() {
            const indicator = document.createElement('div');
            indicator.id = 'autoSaveIndicator';
            indicator.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: rgba(34, 197, 94, 0.9);
                color: white;
                padding: 8px 16px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 500;
                z-index: 10001;
                opacity: 0;
                transition: opacity 0.3s ease;
                pointer-events: none;
            `;
            indicator.textContent = '✓ Đã lưu tự động';
            document.body.appendChild(indicator);

            const originalSaveToHistory = saveToHistory;
            saveToHistory = function () {
                originalSaveToHistory();
                showAutoSaveIndicator();
            };
        }

        function showAutoSaveIndicator() {
            const indicator = document.getElementById('autoSaveIndicator');
            if (indicator) {
                indicator.style.opacity = '1';
                setTimeout(() => indicator.style.opacity = '0', 2000);
            }
        }

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function (e) {
                if (e.key === 'F1' || (e.ctrlKey && e.key === '/')) {
                    e.preventDefault();
                    showKeyboardShortcuts();
                }

                if (e.ctrlKey && e.shiftKey) {
                    switch (e.key) {
                        case 'T':
                            e.preventDefault();
                            addBlockAtCenter('text');
                            break;
                        case 'I':
                            e.preventDefault();
                            addBlockAtCenter('image');
                            break;
                        case 'V':
                            e.preventDefault();
                            addBlockAtCenter('video');
                            break;
                    }
                }

                if (e.ctrlKey && e.key === 'd' && selectedBlock) {
                    e.preventDefault();
                    duplicateBlock(selectedBlock.id);
                }
            });
        }

        function addBlockAtCenter(type) {
            const rect = canvas.getBoundingClientRect();
            const x = rect.width / 2 - getDefaultWidth(type) / 2;
            const y = rect.height / 2 - getDefaultHeight(type) / 2;
            addBlock(type, x, y);
        }

        function showKeyboardShortcuts() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Keyboard Shortcuts</h2>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; font-size: 14px;">
                        <div>
                            <h3>General</h3>
                            <p><kbd>Ctrl + Z</kbd> Undo</p>
                            <p><kbd>Ctrl + Y</kbd> Redo</p>
                            <p><kbd>Ctrl + D</kbd> Duplicate</p>
                            <p><kbd>Delete</kbd> Delete selected</p>
                            <p><kbd>F1</kbd> Show shortcuts</p>
                        </div>
                        <div>
                            <h3>Quick Add</h3>
                            <p><kbd>Ctrl + Shift + T</kbd> Add Text</p>
                            <p><kbd>Ctrl + Shift + I</kbd> Add Image</p>
                            <p><kbd>Ctrl + Shift + V</kbd> Add Video</p>
                        </div>
                        <div>
                            <h3>Movement</h3>
                            <p><kbd>Arrow Keys</kbd> Move 1px</p>
                            <p><kbd>Shift + Arrow</kbd> Move 10px</p>
                            <p><kbd>Enter</kbd> Edit text</p>
                        </div>
                        <div>
                            <h3>Canvas</h3>
                            <p><kbd>Space + Drag</kbd> Pan canvas</p>
                            <p><kbd>Ctrl + 0</kbd> Fit to screen</p>
                            <p><kbd>Ctrl + +/-</kbd> Zoom in/out</p>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.close-btn').addEventListener('click', () => modal.remove());
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        function setupProjectTemplates() {
            const templateBtn = document.createElement('button');
            templateBtn.className = 'btn';
            templateBtn.innerHTML = '📋 Templates';
            templateBtn.addEventListener('click', showTemplates);

            const headerLeft = document.querySelector('.header-left');
            if (headerLeft) headerLeft.appendChild(templateBtn);
        }

        function showTemplates() {
            const templates = [
                {
                    "name": "Portfolio Cá Nhân",
                    "description": "Template chuyên nghiệp cho portfolio cá nhân với header, about, skills, projects và contact",
                    "blocks": [
                        // Header: Full-width background gradient with name and title
                        {
                            "type": "text",
                            "x": 0,
                            "y": 20,
                            "w": 1200,
                            "h": 120,
                            "props": {
                                "content": "Tên của bạn",
                                "fontSize": 64,
                                "color": "#ffffff",
                                "fontWeight": "bold",
                                "textAlign": "center",
                                "lineHeight": "1.2"
                            }
                        },
                        {
                            "type": "text",
                            "x": 0,
                            "y": 90,
                            "w": 1200,
                            "h": 80,
                            "props": {
                                "content": "Web Developer & Designer",
                                "fontSize": 28,
                                "color": "#f0f0f0",
                                "textAlign": "center",
                                "lineHeight": "1.4"
                            }
                        },
                        // Profile image (rounded, with subtle shadow)
                        {
                            "type": "image",
                            "x": 100,
                            "y": 200,
                            "w": 250,
                            "h": 250,
                            "props": {
                                "alt": "Profile Image",
                                "objectFit": "cover",
                                "borderRadius": 50,
                                "overlay": true,
                                "overlayColor": "rgba(0,0,0,0.1)",
                                "overlayText": ""
                            }
                        },
                        // About section: Bio text next to image
                        {
                            "type": "text",
                            "x": 400,
                            "y": 200,
                            "w": 700,
                            "h": 150,
                            "props": {
                                "content": "Giới thiệu về bản thân...\n\nTôi là một developer đam mê tạo ra những trải nghiệm web tuyệt vời. Với hơn 5 năm kinh nghiệm, tôi chuyên về frontend và UI/UX design.",
                                "fontSize": 18,
                                "color": "#333333",
                                "fontWeight": "normal",
                                "textAlign": "left",
                                "lineHeight": "1.6"
                            }
                        },
                        // Skills section: Horizontal bar with icons/text
                        {
                            "type": "text",
                            "x": 100,
                            "y": 380,
                            "w": 1000,
                            "h": 60,
                            "props": {
                                "content": "Skills",
                                "fontSize": 32,
                                "color": "#333333",
                                "fontWeight": "bold",
                                "textAlign": "left"
                            }
                        },
                        // Skill items (as text blocks for simplicity, can be replaced with icons)
                        {
                            "type": "text",
                            "x": 100,
                            "y": 450,
                            "w": 200,
                            "h": 40,
                            "props": {
                                "content": "HTML/CSS/JS",
                                "fontSize": 16,
                                "color": "#007bff",
                                "fontWeight": "bold",
                                "textAlign": "left"
                            }
                        },
                        {
                            "type": "text",
                            "x": 320,
                            "y": 450,
                            "w": 200,
                            "h": 40,
                            "props": {
                                "content": "React & Vue",
                                "fontSize": 16,
                                "color": "#007bff",
                                "fontWeight": "bold",
                                "textAlign": "left"
                            }
                        },
                        {
                            "type": "text",
                            "x": 540,
                            "y": 450,
                            "w": 200,
                            "h": 40,
                            "props": {
                                "content": "UI/UX Design",
                                "fontSize": 16,
                                "color": "#007bff",
                                "fontWeight": "bold",
                                "textAlign": "left"
                            }
                        },
                        {
                            "type": "text",
                            "x": 760,
                            "y": 450,
                            "w": 200,
                            "h": 40,
                            "props": {
                                "content": "Figma & Adobe XD",
                                "fontSize": 16,
                                "color": "#007bff",
                                "fontWeight": "bold",
                                "textAlign": "left"
                            }
                        },
                        // Projects section header
                        {
                            "type": "text",
                            "x": 100,
                            "y": 520,
                            "w": 1000,
                            "h": 60,
                            "props": {
                                "content": "Projects",
                                "fontSize": 32,
                                "color": "#333333",
                                "fontWeight": "bold",
                                "textAlign": "left"
                            }
                        },
                        // Project 1: Image + Title + Description
                        {
                            "type": "image",
                            "x": 100,
                            "y": 590,
                            "w": 300,
                            "h": 200,
                            "props": {
                                "alt": "Project 1",
                                "objectFit": "cover",
                                "borderRadius": 8
                            }
                        },
                        {
                            "type": "text",
                            "x": 420,
                            "y": 590,
                            "w": 600,
                            "h": 40,
                            "props": {
                                "content": "Project 1: E-commerce Website",
                                "fontSize": 20,
                                "color": "#333333",
                                "fontWeight": "bold",
                                "textAlign": "left"
                            }
                        },
                        {
                            "type": "text",
                            "x": 420,
                            "y": 620,
                            "w": 600,
                            "h": 160,
                            "props": {
                                "content": "Mô tả dự án: Một website bán hàng hiện đại với tích hợp React và Stripe. Tính năng chính: Giỏ hàng động, responsive design.",
                                "fontSize": 14,
                                "color": "#666666",
                                "textAlign": "left",
                                "lineHeight": "1.5"
                            }
                        },
                        // Project 2: Similar structure, positioned below
                        {
                            "type": "image",
                            "x": 100,
                            "y": 800,  // Note: Canvas is 800px, this might overflow; adjust if needed
                            "w": 300,
                            "h": 200,
                            "props": {
                                "alt": "Project 2",
                                "objectFit": "cover",
                                "borderRadius": 8
                            }
                        },
                        {
                            "type": "text",
                            "x": 420,
                            "y": 800,
                            "w": 600,
                            "h": 40,
                            "props": {
                                "content": "Project 2: Mobile App Prototype",
                                "fontSize": 20,
                                "color": "#333333",
                                "fontWeight": "bold",
                                "textAlign": "left"
                            }
                        },
                        {
                            "type": "text",
                            "x": 420,
                            "y": 830,
                            "w": 600,
                            "h": 160,
                            "props": {
                                "content": "Mô tả dự án: Prototype app di động sử dụng Figma, tập trung vào UX cho người dùng trẻ.",
                                "fontSize": 14,
                                "color": "#666666",
                                "textAlign": "left",
                                "lineHeight": "1.5"
                            }
                        },
                        // Contact section footer
                        {
                            "type": "text",
                            "x": 100,
                            "y": 1050,  // Extend canvas if needed
                            "w": 1000,
                            "h": 60,
                            "props": {
                                "content": "Contact Me",
                                "fontSize": 28,
                                "color": "#333333",
                                "fontWeight": "bold",
                                "textAlign": "left"
                            }
                        },
                        {
                            "type": "text",
                            "x": 100,
                            "y": 1100,
                            "w": 1000,
                            "h": 100,
                            "props": {
                                "content": "Email: your.email@example.com\nLinkedIn: linkedin.com/in/yourname\nGitHub: github.com/yourname",
                                "fontSize": 16,
                                "color": "#666666",
                                "textAlign": "left",
                                "lineHeight": "1.8"
                            }
                        }
                    ]
                },
                {
                    name: 'Landing Page',
                    description: 'Template cho landing page sản phẩm',
                    blocks: [
                        { type: 'text', x: 100, y: 100, w: 1000, h: 120, props: { content: 'Sản Phẩm Tuyệt Vời', fontSize: 56, fontWeight: 'bold', textAlign: 'center' } },
                        { type: 'text', x: 200, y: 240, w: 800, h: 80, props: { content: 'Mô tả ngắn gọn về sản phẩm', fontSize: 20, textAlign: 'center', color: '#666666' } },
                        { type: 'image', x: 300, y: 350, w: 600, h: 300, props: { alt: 'Product Image' } }
                    ]
                },
                {
                    name: 'Blog Layout',
                    description: 'Template cho blog với sidebar',
                    blocks: [
                        { type: 'text', x: 100, y: 50, w: 800, h: 80, props: { content: 'Tiêu Đề Blog', fontSize: 36, fontWeight: 'bold' } },
                        { type: 'text', x: 100, y: 150, w: 800, h: 400, props: { content: 'Nội dung bài viết...', fontSize: 16 } },
                        { type: 'text', x: 950, y: 150, w: 200, h: 300, props: { content: 'Sidebar\n- Link 1\n- Link 2\n- Link 3', fontSize: 14 } }
                    ]
                }
            ];

            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Project Templates</h2>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div class="template-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px;">
                        ${templates.map((template, index) => `
                        <div class="template-card" style="border: 1px solid #ddd; border-radius: 8px; padding: 16px; cursor: pointer; transition: all 0.2s ease;" data-template="${index}">
                            <h3>${template.name}</h3>
                            <p style="color: #666; font-size: 14px;">${template.description}</p>
                            <div style="background: #f5f5f5; height: 120px; border-radius: 4px; margin-top: 12px; display: flex; align-items: center; justify-content: center; color: #999;">
                                Preview
                            </div>
                        </div>
                        `).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.close-btn').addEventListener('click', () => modal.remove());

            modal.querySelectorAll('.template-card').forEach(card => {
                card.addEventListener('click', () => {
                    const templateIndex = parseInt(card.dataset.template);
                    applyTemplate(templates[templateIndex]);
                    modal.remove();
                });

                card.addEventListener('mouseenter', () => {
                    card.style.borderColor = '#667eea';
                    card.style.transform = 'translateY(-2px)';
                    card.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.15)';
                });

                card.addEventListener('mouseleave', () => {
                    card.style.borderColor = '#ddd';
                    card.style.transform = 'translateY(0)';
                    card.style.boxShadow = 'none';
                });
            });
        }

        function applyTemplate(template) {
            project.blocks = [];
            canvas.innerHTML = '';

            template.blocks.forEach((blockData, index) => {
                const block = {
                    id: 'block-' + Date.now() + '-' + index,
                    type: blockData.type,
                    x: blockData.x,
                    y: blockData.y,
                    w: blockData.w,
                    h: blockData.h,
                    z: index,
                    props: { ...getDefaultProps(blockData.type), ...blockData.props }
                };

                project.blocks.push(block);
                renderBlock(block);
            });

            debounceSaveToHistory();
            updateLayerList();
        }

        function setupAdvancedExport() {
            const exportPdfBtn = document.getElementById('exportPdfBtn');
            const shareProjectBtn = document.getElementById('shareProjectBtn');
            if (exportPdfBtn) exportPdfBtn.addEventListener('click', exportAsPDF);
            if (shareProjectBtn) shareProjectBtn.addEventListener('click', shareProject);
        }

        function exportAsPDF() {
            const exportCanvas = document.createElement('canvas');
            const ctx = exportCanvas.getContext('2d');
            exportCanvas.width = 1200;
            exportCanvas.height = 800;

            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, 1200, 800);

            const link = document.createElement('a');
            link.download = `${project.slug}.png`;
            link.href = exportCanvas.toDataURL();
            link.click();

            showNotification('📄 PDF export đang được phát triển. Hiện tại đã export dưới dạng PNG');
        }

        function shareProject() {
            const shareData = {
                title: project.title,
                text: 'Check out my portfolio project!',
                url: window.location.href
            };

            if (navigator.share) {
                navigator.share(shareData);
            } else {
                const shareUrl = `${window.location.origin}${window.location.pathname}?project=${encodeURIComponent(JSON.stringify(project))}`;
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showNotification('🔗 Link đã được copy vào clipboard!');
                });
            }
        }

        function setupCollaboration() {
            const collabBtn = document.createElement('button');
            collabBtn.className = 'btn';
            collabBtn.innerHTML = '👥 Collaborate';
            collabBtn.addEventListener('click', showCollaborationOptions);

            const headerRight = document.querySelector('.header-right');
            if (headerRight) headerRight.insertBefore(collabBtn, headerRight.firstChild);
        }

        function showCollaborationOptions() {
            const modal = document.createElement('div');
            modal.className = 'modal show';
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Collaboration</h2>
                        <button class="close-btn">&times;</button>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <div style="padding: 16px; border: 1px solid #ddd; border-radius: 8px;">
                            <h3>💬 Comments</h3>
                            <p>Thêm comments vào các elements (Coming soon)</p>
                            <button class="btn" disabled>Enable Comments</button>
                        </div>
                        <div style="padding: 16px; border: 1px solid #ddd; border-radius: 8px;">
                            <h3>🔄 Version History</h3>
                            <p>Xem lịch sử thay đổi project</p>
                            <button class="btn" onclick="showVersionHistory()">View History</button>
                        </div>
                        <div style="padding: 16px; border: 1px solid #ddd; border-radius: 8px;">
                            <h3>📤 Export & Share</h3>
                            <p>Chia sẻ project với team</p>
                            <button class="btn" onclick="generateShareableLink()">Generate Link</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            modal.querySelector('.close-btn').addEventListener('click', () => modal.remove());

            window.showVersionHistory = function () {
                const historyModal = document.createElement('div');
                historyModal.className = 'modal show';
                historyModal.innerHTML = `
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Version History</h2>
                            <button class="close-btn">&times;</button>
                        </div>
                        <div style="max-height: 400px; overflow-y: auto;">
                            ${project.history.map((version, index) => `
                            <div style="padding: 12px; border-bottom: 1px solid #eee; cursor: pointer;" onclick="restoreVersion(${index})">
                                <div style="font-weight: 500;">Version ${index + 1}</div>
                                <div style="font-size: 12px; color: #666;">${version.blocks.length} blocks</div>
                            </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                document.body.appendChild(historyModal);

                historyModal.querySelector('.close-btn').addEventListener('click', () => historyModal.remove());

                window.restoreVersion = function (index) {
                    if (index < project.history.length) {
                        historyIndex = index;
                        restoreFromHistory();
                        historyModal.remove();
                    }
                };
            };

            window.generateShareableLink = function () {
                const shareableData = { ...project, sharedAt: new Date().toISOString() };
                const shareUrl = `${window.location.origin}${window.location.pathname}?shared=${encodeURIComponent(btoa(JSON.stringify(shareableData)))}`;
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showNotification('Shareable link copied to clipboard!');
                });
            };
        }

        // Load saved project on startup
        const savedProject = localStorage.getItem('portfolio-project');
        if (savedProject) {
            try {
                const loaded = JSON.parse(savedProject);
                if (loaded.blocks && Array.isArray(loaded.blocks)) {
                    project = { ...project, ...loaded };
                    requestAnimationFrame(() => {
                        project.blocks.forEach(block => renderBlock(block));
                        updateUI();
                    });
                }
            } catch (e) {
                console.error('Failed to load saved project:', e);
            }
        }
        function createClickBurst(e) {
            const container = document.createElement('div');
            container.className = 'click-effect-container';

            container.style.left = `${e.pageX - 25}px`;
            container.style.top = `${e.pageY - 25}px`;

            document.body.appendChild(container);

            const PARTICLE_COUNT = 12;
            const colors = ['#0066FF', '#3399FF', '#FFD700', '#FFFFFF', '#8A2BE2', '#FC46AD'];

            for (let i = 0; i < PARTICLE_COUNT; i++) {
                const particle = document.createElement('div');
                particle.className = 'click-effect-particle';

                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                particle.style.width = '10px';
                particle.style.height = '10px';
                particle.style.transform = 'translate(15px, 15px) scale(1)';
                particle.style.opacity = '1';

                container.appendChild(particle);

                const angle = (360 / PARTICLE_COUNT) * i; // Góc bay ra
                const radius = 50 + Math.random() * 40;   // Khoảng cách bay ra
                const x = radius * Math.cos(angle * Math.PI / 180); // Tọa độ x cuối cùng
                const y = radius * Math.sin(angle * Math.PI / 180); // Tọa độ y cuối cùng

                setTimeout(() => {
                    // Style cuối cùng của mảnh vỡ (sau khi đã bay ra)
                    particle.style.transform = `translate(${x}px, ${y}px) scale(0)`;
                    particle.style.opacity = '0';
                }, 10);
            }
            setTimeout(() => {
                container.remove();
            }, 700);
        }
        function handleWheelZoom(e) {
    if (!e.ctrlKey) return; // Chỉ zoom khi giữ Ctrl
    e.preventDefault();

    const delta = e.deltaY > 0 ? -0.1 : 0.1; // Cuộn xuống: zoom out, lên: zoom in
    zoomCanvas(delta);

    // Prevent page scroll
    e.stopPropagation();
}

function zoomCanvas(delta) {
    zoomLevel = Math.max(minZoom, Math.min(maxZoom, zoomLevel + delta));
    applyZoom();

    // Update button states (optional visual feedback)
    updateZoomButtons();
}

function resetZoom() {
    zoomLevel = 1.0;
    applyZoom();
    updateZoomButtons();
}

function applyZoom() {
    if (canvas) {
        canvas.style.transform = `scale(${zoomLevel})`;
        // Adjust container nếu cần (e.g., update scroll)
        const canvasContainer = document.querySelector('.canvas-container');
        if (canvasContainer) {
            canvasContainer.classList.add('zoom-container');
            // Optional: Adjust margin/padding cho center zoom
            canvasContainer.scrollLeft *= zoomLevel;
            canvasContainer.scrollTop *= zoomLevel;
        }
    }
}

function updateZoomButtons() {
    const zoomInBtn = document.getElementById('zoomInBtn');
    const zoomOutBtn = document.getElementById('zoomOutBtn');
    const zoomResetBtn = document.getElementById('zoomResetBtn');

    if (zoomInBtn) zoomInBtn.disabled = zoomLevel >= maxZoom;
    if (zoomOutBtn) zoomOutBtn.disabled = zoomLevel <= minZoom;
    if (zoomResetBtn) zoomResetBtn.classList.toggle('active', zoomLevel === 1.0);
}

// Reset zoom khi thay breakpoint (paste vào cuối updateCanvasSize())
function updateCanvasSize() {
    // ... (code cũ giữ nguyên)
    resetZoom(); // Reset zoom khi thay view
}
        // Gắn hàm xử lý sự kiện vào toàn bộ trang
        document.addEventListener('click', createClickBurst);
        const urlParams = new URLSearchParams(window.location.search);
        const sharedProject = urlParams.get('shared');
        if (sharedProject) {
            try {
                const decoded = JSON.parse(atob(sharedProject));
                if (decoded.blocks && Array.isArray(decoded.blocks)) {
                    project = { ...project, ...decoded };
                    requestAnimationFrame(() => {
                        project.blocks.forEach(block => renderBlock(block));
                        updateUI();
                    });
                    showNotification('📤 Loaded shared project!');
                }
            } catch (e) {
                console.error('Failed to load shared project:', e);
            }
        }

        function showNotification(text) {
            const notification = document.createElement('div');
            notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(102, 126, 234, 0.9);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        z-index: 10002;
    `;

            notification.textContent = text;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }
    </script>
</body>

</html>